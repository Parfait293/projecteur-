<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Projo-Connect Innov'</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --bg: #0f172a; --panel: #1e293b; --accent: #10b981; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: white; height: 100vh; display: flex; overflow: hidden; }
        
        /* Ecran d'accueil */
        .overlay { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .card { background: rgba(255,255,255,0.05); backdrop-filter: blur(15px); padding: 30px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); width: 320px; text-align: center; }
        
        /* Layout Principal */
        .main { flex: 1; display: none; flex-direction: column; }
        .sidebar { width: 280px; background: var(--panel); border-left: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; }
        
        /* Zone de contenu */
        .content { flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        #canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 10; }
        #canvas.active { pointer-events: auto; cursor: crosshair; }
        
        /* UI Elements */
        .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; }
        .btn-accent { background: var(--accent); }
        input { background: rgba(0,0,0,0.2); border: 1px solid #333; color: white; padding: 12px; border-radius: 10px; width: calc(100% - 26px); margin: 5px 0; }
        
        .chat-area { flex: 1; overflow-y: auto; padding: 15px; font-size: 0.85rem; }
        .controls { padding: 10px; background: var(--panel); display: flex; gap: 5px; flex-wrap: wrap; }
        .badge { background: var(--primary); padding: 2px 8px; border-radius: 5px; font-size: 0.7rem; }
    </style>
</head>
<body>

<div id="setup" class="overlay">
    <div class="card">
        <h2>üöÄ Projo-Connect</h2>
        <input type="text" id="userName" placeholder="Ton nom">
        <hr style="opacity:0.1; margin: 15px 0;">
        <input type="text" id="roomName" placeholder="Nom de la salle">
        <button class="btn" onclick="initSession(true)">‚ûï Cr√©er la salle</button>
        <button class="btn btn-accent" onclick="initSession(false)">üîó Rejoindre</button>
        <p id="status" style="font-size: 0.7rem; color: var(--primary); margin-top: 10px;">En attente...</p>
    </div>
</div>

<div id="app" class="main">
    <div class="content" id="viewer">
        <canvas id="canvas"></canvas>
        <div id="mediaContainer" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
            <p>En attente du professeur...</p>
        </div>
    </div>

    <div class="controls">
        <div id="profButtons" style="display:none; display:flex; gap:5px;">
            <button class="btn" style="width:auto" onclick="document.getElementById('fileIn').click()">üìÅ Fichier</button>
            <button class="btn" id="drawBtn" style="width:auto; background:#f59e0b" onclick="toggleDraw()">‚úèÔ∏è Dessiner</button>
            <button class="btn" style="width:auto; background:#ef4444" onclick="clearAll()">üßπ Clear</button>
        </div>
        <button class="btn" style="width:auto; background:#6b7280" onclick="raiseHand()">üñêÔ∏è Lever la main</button>
        <input type="file" id="fileIn" hidden onchange="shareFile(this)">
    </div>
</div>

<div class="sidebar" id="sidebar">
    <div style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.1)">
        <b>Discussion</b> <span class="badge" id="peerCount">0</span>
    </div>
    <div class="chat-area" id="chat"></div>
    <div style="padding:10px; display:flex;">
        <input type="text" id="msgIn" placeholder="Message..." style="margin:0; flex:1">
        <button class="btn" style="width:auto; margin:0 0 0 5px;" onclick="sendMsg()">OK</button>
    </div>
</div>

<script>
    let peer, myConn, connections = [];
    let isProf = false;
    let currentContent = null;
    let drawing = false;
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // --- INITIALISATION ---
    function initSession(host) {
        isProf = host;
        const room = document.getElementById('roomName').value;
        const name = document.getElementById('userName').value || "Utilisateur";
        if(!room) return alert("Nom de salle requis");

        peer = host ? new Peer(room) : new Peer();
        document.getElementById('status').innerText = "Connexion au r√©seau...";

        peer.on('open', (id) => {
            if(host) {
                startApp();
            } else {
                myConn = peer.connect(room, { metadata: { name: name } });
                setupConn(myConn);
            }
        });

        peer.on('connection', (conn) => {
            connections.push(conn);
            setupConn(conn);
            updateCount();
            // Innovation : Renvoi automatique du cours √† l'√©l√®ve qui arrive
            if(currentContent) {
                setTimeout(() => conn.send({ type: 'file', ...currentContent }), 1000);
            }
        });

        peer.on('error', () => alert("Erreur : Salle d√©j√† prise ou code erron√©."));
    }

    function setupConn(c) {
        c.on('open', () => {
            startApp();
            addChat("Syst√®me", "Connect√© !");
        });
        c.on('data', (data) => {
            if(data.type === 'file') renderFile(data.content, data.mime);
            if(data.type === 'chat') addChat(data.user, data.msg);
            if(data.type === 'draw') remoteDraw(data);
            if(data.type === 'clear') clearCanvas();
        });
    }

    function startApp() {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        if(isProf) document.getElementById('profButtons').style.display = 'flex';
        resizeCanvas();
    }

    // --- PARTAGE DE FICHIER ---
    function shareFile(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            currentContent = { content: e.target.result, mime: file.type };
            renderFile(currentContent.content, currentContent.mime);
            broadcast({ type: 'file', ...currentContent });
        };
        reader.readAsDataURL(file);
    }

    function renderFile(data, mime) {
        const container = document.getElementById('mediaContainer');
        if(mime.includes('video')) container.innerHTML = `<video src="${data}" controls autoplay style="max-height:100%"></video>`;
        else if(mime.includes('pdf')) container.innerHTML = `<iframe src="${data}" style="width:100%;height:100%"></iframe>`;
        else container.innerHTML = `<img src="${data}" style="max-height:100%">`;
    }

    // --- TABLEAU BLANC (INNOVATION) ---
    function toggleDraw() {
        drawing = !drawing;
        canvas.classList.toggle('active', drawing);
        document.getElementById('drawBtn').style.background = drawing ? "#ef4444" : "#f59e0b";
    }

    function resizeCanvas() {
        canvas.width = document.getElementById('viewer').clientWidth;
        canvas.height = document.getElementById('viewer').clientHeight;
    }

    canvas.onmousedown = (e) => { if(!drawing) return; canvas.isDrawing = true; };
    canvas.onmousemove = (e) => {
        if(!canvas.isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        drawDot(x, y);
        broadcast({ type: 'draw', x: x / canvas.width, y: y / canvas.height });
    };
    window.onmouseup = () => canvas.isDrawing = false;

    function drawDot(x, y) {
        ctx.fillStyle = "red";
        ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
    }

    function remoteDraw(data) {
        drawDot(data.x * canvas.width, data.y * canvas.height);
    }

    function clearAll() { clearCanvas(); broadcast({ type: 'clear' }); }
    function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    // --- CHAT ET ZOOM FUNCTIONS ---
    function sendMsg() {
        const msg = document.getElementById('msgIn').value;
        const name = document.getElementById('userName').value || (isProf ? "PROF" : "√âL√àVE");
        if(!msg) return;
        addChat("Moi", msg);
        broadcast({ type: 'chat', user: name, msg: msg });
        document.getElementById('msgIn').value = "";
    }

    function raiseHand() {
        const name = document.getElementById('userName').value || "√âl√®ve";
        broadcast({ type: 'chat', user: "SYST√àME", msg: `üñêÔ∏è ${name} l√®ve la main !` });
        addChat("Syst√®me", "Vous avez lev√© la main.");
    }

    function addChat(user, msg) {
        const chat = document.getElementById('chat');
        chat.innerHTML += `<div><b style="color:var(--primary)">${user}:</b> ${msg}</div>`;
        chat.scrollTop = chat.scrollHeight;
    }

    function broadcast(data) {
        if(isProf) connections.forEach(c => c.send(data));
        else if(myConn) myConn.send(data);
    }

    function updateCount() {
        document.getElementById('peerCount').innerText = connections.length;
    }
</script>
</body>
</html>
